----------------------------------------------EC2-----------------------------------------------------------------------------------
elastic compute cloud
ec2 instances are virtual server
billed by second
EC2 service provisioned EC2 instances/virtual servers
creates and manage life cycle of ec2 instances,
load balancing and auto-scaling ,
attach storage
manage network

Security Group
is like a Virtual Firewall having inbound/outbound rules

Instance Types
compute CPU,GPU

t2.micro
t is instance family (t is General purpose instance)
2 is generation 
micro size
nano<micro<small<medium<large<xlarge

1) Change Region to   (close to ur location)
Asia Pacific (Mumbai) ap-south-1
2) EC2 --> Create instances
3) AMI Amazon Machine Image
Amazon Linux 2 AMI (HVM), SSD Volume Type	

4) Security Group
my-EC2-security-group	

5) create new keypair file
and download EC2-keypair.perm at 
C:\Users\AliImran\Box Sync\P52\My-Learning\My-AWS\Architect\in28Minutes-AWS\LABS

6) Connect
EC2 Instance Connect (browser-based SSH connection)

cmd
whoami
python --version

6) Security Group 
Add

HTTP
AnyWhere

All ICMP ipv4  (used for ping public ip)
AnyWhere


7)
Open Command Prompt
cd C:\Users\AliImran\Box Sync\P52\My-Learning\My-AWS\Architect\in28Minutes-AWS\LABS
ssh -i "EC2-keypair.pem" ec2-user@ec2-13-234-77-166.ap-south-1.compute.amazonaws.com


8) 
sudo su
yum update -y
yum install httpd
systemctl start httpd
systemctl enable httpd
echo "Hello World" > /var/www/html/index.html



curl -s http://13.234.77.166/latest/dynamic/instance-identity/document > /var/www/html/index.html

1) EC2 instance metadata service 
get details about EC2 instance

URL accessible within he EC2 instance only
http://url/lates/meta-data/

curl http://ec2-13-234-77-166.ap-south-1.compute.amazonaws.com/latest/meta-data/ami-id/
curl http://13.234.77.166/latest/meta-data/hostname
curl http://13.234.77.166/latest/meta-data/instance-id
curl http://13.234.77.166/latest/meta-data/instance-type



curl -L http://13.234.77.166/latest/meta-data/

You can get
AMI Id
Storage  Devices
DNS hostname
instance id
instance type
security groups
IP addresses

2) dynamic data service

curl http://13.234.77.166/latest/dynamic
curl http://13.234.77.166/latest/dynamic/instance-identity
curl http://13.234.77.166/latest/dynamic/instance-identity/document


9) 

echo "EC2 Instance-2 with ($(whoami) ) on host ($(hostname)) with ip ($(hostname -i))" > /var/www/html/index.html

curl http://localhost/latest/dynamic/instance-identity/document > /var/www/html/index.html


Security Group 
defence in depth

** if there is no rules , no traffic is allowed 
you can specific only allow rules only rest is not allowed by default
can assign up to 5 security groups
No restart is required for Ec2
* Security Group are stateful , if outgoing/incoming is allowed, the incoming  response for it is automatically allowed
timeout in case of security group not allowed

EC2 IP Addresses

Public address
internet addressable

Private address
internal to the corporate network

Can't have two resources with same public IP address
however, two diff corporate networks can have resources with same private IP address
All Ec2 instances are assigned to private IP address but public is not assigned automatically
** Stop/Start EC2 Public IP is changed but private is same 
** reboot will not change public IP

------------Elastic IP-----
constant IIP
Normally  where 1 instance is required it is ok

Go to Ec2
Elastic IPs
Allocate an IP
Action Associate with instnace

Now in instance the public IP is associated with the elastic ip
when instance is stopped even elastic IP is there 

*** Elastic IPs can  be swithced to other ec2 insce within the SAME region
they need to be manually detached
*** If elastic ip is not in used or if ec2 instance associated with it is stopped  then u will be charged
better is to relase the elatic ip

----------EC2 HTTP Server Setup--------------
userdata
script used at launch of the instance

bootstraping 
install os patches or sofware when ec2 instance is launched

Create another Ec2 isntance

Add below in the userdata
#!/bin/bash
yum update -y
yum install httpd
systemctl start httpd
systemctl enable httpd
echo "EC2 Instance-2 with ($(whoami) ) on host ($(hostname)) with ip ($(hostname -i))" > /var/www/html/index.html


sudo su
yum update -y
yum install httpd
systemctl start httpd
systemctl enable httpd
echo "EC2 Instance-2 with ($(whoami) ) on host ($(hostname)) with ip ($(hostname -i))" > /var/www/html/index.html

cd C:\Users\AliImran\Box Sync\P52\My-Learning\My-AWS\Architect\in28Minutes-AWS\LABS
ssh -i "EC2-keypair.pem" ec2-user@ec2-35-154-93-55.ap-south-1.compute.amazonaws.com


http://ec2-35-154-93-55.ap-south-1.compute.amazonaws.com

----------------------------------------------Launch Template userdata-------------------------------------------------------

Use launch templates to automate instance launches, simplify permission policies, 
and enforce best practices across your organization. Save launch parameters in a template 
that can be used for on-demand launches and with managed services, including 
EC2 Auto Scaling and EC2 Fleet. Easily update your launch parameters by creating a 
new launch template version.

EC2 --> Launch templates --> Create launch template

Name
MyEC2Template

AMI
Amazon Linux 2 AMI (HVM), SSD Volume Type - ami-09a7bbd08886aafdf (64-bit x86) / ami-011abae98ef4c1bfa (64-bit Arm)

Instance Type
t2.micro

Keypair 
EC2-keypair

Security Group
my-EC2-security-group

userdata

#!/bin/bash
yum update -y
yum install -y httpd
systemctl start httpd
systemctl enable httpd
echo "EC2 Instance with ($(whoami) ) on host ($(hostname)) with ip ($(hostname -i))" > /var/www/html/index.html

Go to Instances
Launch Instance from template
Select MyEC2template

http://ec2-3-7-66-215.ap-south-1.compute.amazonaws.com/
EC2 Instance with (root ) on host (ip-172-31-14-110.ap-south-1.compute.internal) with ip (172.31.14.110)

http://ec2-13-233-53-139.ap-south-1.compute.amazonaws.com
EC2 Instance with (root ) on host (ip-172-31-13-231.ap-south-1.compute.internal) with ip (172.31.13.231) 


----------------------------------------------Customised AMI-------------------------------------------------------

for installing OS patches and software using userdata at the launch of EC2 isntance increases bootup time
also called Hardening an Image cusomised EC2 images to your ciporate securiyt standards)

Select a running instance
Action - Image -- Create Image
Name
MyCusomizedEc2AMI

Create Image
Once Image is created go to

Go to AMI
Now Launch Template (template can have multiple version)
Action - Modify template
create new version  V2

Go to Template
Create instance from template
select V2

AMI Image contains
OS and software on that instances
have root volume also attach non root volumes
can be shared with other accounts (Permissions -- add account no.)
AMI are stored in S3 and are region specific, so can be created instancees in AZs of that region
better to backup AMI in other regions for DR (Copy AMI to other regions)

Three AMI sources
1) by AWS
2) AWS market Place  Per hour billing
3) Customised AMI


AMI - Action -- DeregisterAMI
SnapShot- Action- Delete

Trouble shooting
EC2-keypair.pem is the private key
chmod 400 EC2-keypair.pem (read only to the owner)
as 0777(default , v open) not recommended
use public DNS or IP to connect 


for windows instances
1) private key
2) admin pwd
decrypt the pwd using private key and login via RDP
3) Security group allow (otherwise timeout can probably come)
SSH 22
RDP 3389

EC2 uses public key cryptography using RSA
public key is stored in EC2 instance
private key is stored by customer


For putty
create ec2_instance1_KP.ppk using puttygen and coonect to EC2 instance

If you stopped EC2 instances then still EBS volumes (harddisk) will be there and u will be charged

----------------------------------------------Good EC2 Scenarios------------------------------------------------------

Q1:  identify all instances belonging to a project, to an eviroment
SOL: tags

Q2: Change instance type
SOL: stop the instance and then change its type

Q3: don't want an EC2 instance to be automatically  terminated 
ie from Action-Instace Sate- Terminate
SOL: Change Termination Protection to Enable
also can be set during instance creation
But EC2 Terminal protection is not effective for termination from
1) Auto Scaling Groups (ASG)
2) Spot Instances
3) OS shutdown

Q4: Update EC2 instance to a new AMI with latest patches
SOL:create/relaunch a new instance with updated AMI

Q5: create EC2 instances based on on-premise VMs
SOL: yes, using import/export , you are responsible for licenses

Q6:Changing security group
SOL: easily chnage/delete securoy group to an instance
multiple security group can also be assigned

Q7: Timeout
SOL:	inbound rule for security group to check

Q8: Installing a lot of woftwares sing userdata that slowing down instance launch
how to make it faster
SOL:	cusom AMI-------------------------------------------------------

Q9: stopped EC2 instance, will I get bill
SOL:	if u have storage 

Turn On Termination Protection to protect EC2 instances for termination
as this option will disable terminate menu

-------------------------Creating EC2 in different Zones--------------------------------------------------------------------------------------------------------

No. of Availability Zones in a Region = No. of subnets 

Services - VPC

A VPC is created default in every region


----------------------------Billing in AWS---------------------------------------------------------------------------------

1) Set Billing Alerts
2) Monitor Every day for first week
3)

My Account
IAM User and Role Access to Billing Information
Activate IAM Access

Billing Alerts
My Billing Dashboard
Billing Preference

CloudWatch

1) At the moment, CloudWatch displays all billing data and alarms in US East (N. Virginia)
so switch to it

2) Select Billing

3) Create Billing alert

4) create SNS topic
CloudWatch_Alarms_Topic

monitoring service and trigger alarm
create alarm
create topic


1) Gto to Budget
2) create a new budget 
Cost Budget
MonthlyBudget
3) Monthly
4) Budgeted amount 
$0.01
